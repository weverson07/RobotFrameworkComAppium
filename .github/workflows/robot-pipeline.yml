name: ü§ñ Pipeline Robot Framework + Envio SCP

on:
  push:
    branches:
      - master
  pull_request:

jobs:
  robot-test:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout do c√≥digo
        uses: actions/checkout@v3

      - name: üêç Configurar Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: üì¶ Instalar depend√™ncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: üöÄ Executar testes Robot Framework
        run: |
          robot -d output tests/

      - name: üîê Configurar chave SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
        run: |
          mkdir -p ~/.ssh
          printf "%s\n" "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $REMOTE_HOST >> ~/.ssh/known_hosts

      - name: üîç Verificar Secrets (debug)
        env:
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_PATH: ${{ secrets.REMOTE_PATH }}
        run: |
          echo "REMOTE_USER est√° definido? ${REMOTE_USER:+Sim}"
          echo "REMOTE_HOST est√° definido? ${REMOTE_HOST:+Sim}"
          echo "REMOTE_PATH est√° definido? ${REMOTE_PATH:+Sim}"

      - name: üì§ Enviar relat√≥rios via SCP
        env:
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_PATH: ${{ secrets.REMOTE_PATH }}
        shell: bash
        run: |
          scp -r output/* $REMOTE_USER@$REMOTE_HOST:$REMOTE_PATH

      - name: ‚úÖ Finalizado
        run: echo "Testes finalizados e relat√≥rio enviado com sucesso! üöÄ"
